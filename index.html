<!DOCTYPE html><html lang="en">
<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Flow Forecast - Monthly Period Prediction</title>
      <style>
            body {
                  font-family: 'Segoe UI', Arial, sans-serif;
                  background: linear-gradient(135deg, #f8fafc 0%, #e0e7ef 100%);
                  min-height: 100vh;
                  margin: 0;
                  padding: 0;
                  display: flex;
                  align-items: center;
                  justify-content: center;
            }
            .container {
                  background: #fff;
                  border-radius: 18px;
                  box-shadow: 0 4px 24px rgba(0,0,0,0.08);
                  padding: 2.5rem 2rem 2rem 2rem;
                  max-width: 420px;
                  width: 100%;
                  margin: 2rem 1rem;
            }
            h1 {
                  text-align: center;
                  color: #2d3748;
                  margin-bottom: 0.5rem;
            }
            sub {
                  display: block;
                  text-align: center;
                  color: #4a5568;
                  font-weight: 600;
                  margin-bottom: 1.5rem;
            }
            hr {
                  margin-bottom: 1.5rem;
            }
            label {
                  margin-top: 1rem;
                  color: #4a5568;
                  font-weight: 500;
            }
            input[type="date"], input[type="number"] {
                  width: 100%;
                  padding: 0.6rem;
                  border: 1px solid #cbd5e1;
                  border-radius: 8px;
                  margin-top: 0.3rem;
                  font-size: 1rem;
                  background: #f7fafc;
                  box-sizing: border-box;
            }
            button {
                  width: 100%;
                  padding: 0.8rem;
                  background: #2563eb;
                  color: #fff;
                  border: none;
                  border-radius: 8px;
                  font-size: 1.1rem;
                  font-weight: 600;
                  margin-top: 1.5rem;
                  cursor: pointer;
                  transition: background 0.2s;
            }
            button:hover {
                  background: #1e40af;
            }
            .result {
                  margin-top: 1.5rem;
                  font-weight: bold;
                  text-align: center;
                  color: #2563eb;
                  font-size: 1.2rem;
            }
            .chart-container {
                  margin-top: 2.5rem;
                  background: #f1f5f9;
                  border-radius: 12px;
                  padding: 1.2rem 0.8rem 0.5rem 0.8rem;
            }
            .month-navigation {
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  margin: 1.5rem 0;
                  padding: 1rem;
                  background: #f8fafc;
                  border-radius: 12px;
                  border: 1px solid #e2e8f0;
            }
            .month-navigation h3 {
                  margin: 0;
                  color: #2d3748;
                  font-size: 1.1rem;
                  font-weight: 600;
            }
            .month-navigation button {
                  background: #ffffff;
                  border: 1px solid #cbd5e1;
                  border-radius: 8px;
                  padding: 0.5rem 1rem;
                  font-size: 0.9rem;
                  color: #4a5568;
                  cursor: pointer;
                  transition: all 0.2s;
                  width: auto;
                  margin: 0;
            }
            .month-navigation button:hover {
                  background: #f1f5f9;
                  border-color: #94a3b8;
            }
            @media (max-width: 600px) {
                  .container {
                        padding: 1.2rem 0.5rem 1rem 0.5rem;
                  }
                  .month-navigation {
                        padding: 0.8rem;
                  }
                  .month-navigation h3 {
                        font-size: 1rem;
                  }
                  .month-navigation button {
                        padding: 0.4rem 0.8rem;
                        font-size: 0.8rem;
                  }
            }
      </style>
</head>
<body>
      <div class="container">
            <h1>Flow Forecast</h1>
            <sub>Monthly Period Probability Calculator</sub>

            <hr>

            <div>
                  <label for="lastPeriod">Last Period Start Date:</label>
                  <input type="date" id="lastPeriod">
                  
                  <label for="cycleLength">Average Cycle Length (days):</label>
                  <input type="number" id="cycleLength" value="28">
                  
                  <label for="periodLength">Average Period Length (days):</label>
                  <input type="number" id="periodLength" value="5">
                  
                  <div class="month-navigation">
                        <button id="prevMonth" onclick="changeMonth(-1)">◀ Previous</button>
                        <h3 id="currentMonth">January 2024</h3>
                        <button id="nextMonth" onclick="changeMonth(1)">Next ▶</button>
                  </div>
                  
                  <button onclick="calculateMonthProbability()">Calculate Monthly Forecast</button>
                  
                  <div class="result" id="result"></div>
                  <div class="chart-container">
                        <canvas id="bellCurve" height="200"></canvas>
                  </div>
            </div>
      </div>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
            // Global variables
            let currentMonthDate = new Date();
            let chart;

            // Set default values and initialize month navigation
            window.addEventListener('DOMContentLoaded', () => {
                  const today = new Date();
                  const pad = n => n.toString().padStart(2, '0');
                  const yyyy = today.getFullYear();
                  const mm = pad(today.getMonth() + 1);
                  const dd = pad(today.getDate());
                  const todayStr = `${yyyy}-${mm}-${dd}`;

                  document.getElementById('lastPeriod').value = todayStr;
                  
                  // Set current month to next month
                  currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
                  updateMonthDisplay();
            });

            // Update the month display
            function updateMonthDisplay() {
                  const monthNames = ["January", "February", "March", "April", "May", "June",
                        "July", "August", "September", "October", "November", "December"];
                  const monthDisplay = `${monthNames[currentMonthDate.getMonth()]} ${currentMonthDate.getFullYear()}`;
                  document.getElementById('currentMonth').textContent = monthDisplay;
            }

            // Change month (direction: -1 for previous, +1 for next)
            function changeMonth(direction) {
                  currentMonthDate.setMonth(currentMonthDate.getMonth() + direction);
                  updateMonthDisplay();
                  
                  // Auto-calculate if we have valid inputs
                  const lastPeriod = document.getElementById('lastPeriod').value;
                  const cycleLength = document.getElementById('cycleLength').value;
                  const periodLength = document.getElementById('periodLength').value;
                  
                  if (lastPeriod && cycleLength && periodLength) {
                        calculateMonthProbability();
                  }
            }

            // Main calculation function for monthly forecast
            function calculateMonthProbability() {
                  const lastPeriod = new Date(document.getElementById('lastPeriod').value);
                  const cycleLength = parseInt(document.getElementById('cycleLength').value);
                  const periodLength = parseInt(document.getElementById('periodLength').value);
                  
                  if (!lastPeriod || isNaN(cycleLength) || isNaN(periodLength)) {
                        document.getElementById('result').textContent = "Please fill all inputs correctly.";
                        clearChart();
                        return;
                  }
                  
                  // Get the first and last day of the current viewing month
                  const firstDayOfMonth = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth(), 1);
                  const lastDayOfMonth = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth() + 1, 0);
                  const daysInMonth = lastDayOfMonth.getDate();
                  
                  // Monte Carlo simulation
                  const simulations = 100000;
                  const dailyProbabilities = Array(daysInMonth).fill(0);
                  let anyPeriodInMonth = 0;
                  
                  for (let i = 0; i < simulations; i++) {
                        // Add variation to cycle and period lengths
                        const cycle = cycleLength + (Math.random() * 4 - 2); // +/- 2 days variation
                        const period = periodLength + (Math.random() * 2 - 1); // +/- 1 day variation
                        
                        // Find all periods that could overlap with the target month
                        let nextPeriodStart = new Date(lastPeriod);
                        let foundPeriodInMonth = false;
                        
                        // Look ahead to find periods that might affect this month
                        for (let cycles = 0; cycles < 12; cycles++) { // Check up to 12 cycles ahead
                              nextPeriodStart.setDate(nextPeriodStart.getDate() + cycle);
                              
                              const periodStart = new Date(nextPeriodStart);
                              const periodEnd = new Date(nextPeriodStart);
                              periodEnd.setDate(periodStart.getDate() + period - 1); // period length includes start day
                              
                              // Check if this period overlaps with our target month
                              if (periodEnd >= firstDayOfMonth && periodStart <= lastDayOfMonth) {
                                    foundPeriodInMonth = true;
                                    
                                    // Mark each day in the month that has period
                                    for (let day = 1; day <= daysInMonth; day++) {
                                          const checkDate = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth(), day);
                                          if (checkDate >= periodStart && checkDate <= periodEnd) {
                                                dailyProbabilities[day - 1]++;
                                          }
                                    }
                              }
                              
                              // Stop if we're well past the target month
                              if (nextPeriodStart > lastDayOfMonth && 
                                  (nextPeriodStart.getTime() - lastDayOfMonth.getTime()) > (90 * 24 * 60 * 60 * 1000)) {
                                    break;
                              }
                        }
                        
                        if (foundPeriodInMonth) {
                              anyPeriodInMonth++;
                        }
                  }
                  
                  // Convert counts to percentages
                  const dailyPercentages = dailyProbabilities.map(count => (count / simulations) * 100);
                  const monthlyChance = (anyPeriodInMonth / simulations) * 100;
                  
                  // Find peak probability day
                  const maxProbability = Math.max(...dailyPercentages);
                  const peakDay = dailyPercentages.indexOf(maxProbability) + 1;
                  
                  // Display results
                  const monthName = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentMonthDate);
                  document.getElementById('result').innerHTML = 
                        `<strong>${monthName}</strong><br>` +
                        `Chance of period: <strong>${monthlyChance.toFixed(1)}%</strong><br>` +
                        `Peak probability: Day ${peakDay} (${maxProbability.toFixed(1)}%)`;
                  
                  // Create bell curve chart
                  drawMonthlyChart(dailyPercentages, daysInMonth);
            }

            // Draw the monthly probability chart using native Canvas
            function drawMonthlyChart(dailyPercentages, daysInMonth) {
                  const canvas = document.getElementById('bellCurve');
                  const ctx = canvas.getContext('2d');
                  
                  // Set canvas size
                  const rect = canvas.getBoundingClientRect();
                  canvas.width = rect.width * window.devicePixelRatio;
                  canvas.height = 200 * window.devicePixelRatio;
                  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
                  
                  // Chart dimensions
                  const padding = 40;
                  const chartWidth = rect.width - padding * 2;
                  const chartHeight = 200 - padding * 2;
                  
                  // Clear canvas
                  ctx.clearRect(0, 0, rect.width, 200);
                  
                  // Find max value for scaling
                  const maxValue = Math.max(...dailyPercentages, 10); // minimum 10% for scaling
                  
                  // Draw grid lines
                  ctx.strokeStyle = '#e5e7eb';
                  ctx.lineWidth = 1;
                  for (let i = 0; i <= 5; i++) {
                        const y = padding + (chartHeight * i / 5);
                        ctx.beginPath();
                        ctx.moveTo(padding, y);
                        ctx.lineTo(padding + chartWidth, y);
                        ctx.stroke();
                  }
                  
                  // Draw axes
                  ctx.strokeStyle = '#374151';
                  ctx.lineWidth = 2;
                  ctx.beginPath();
                  ctx.moveTo(padding, padding);
                  ctx.lineTo(padding, padding + chartHeight);
                  ctx.lineTo(padding + chartWidth, padding + chartHeight);
                  ctx.stroke();
                  
                  // Draw data line
                  ctx.strokeStyle = '#2563eb';
                  ctx.fillStyle = 'rgba(37,99,235,0.1)';
                  ctx.lineWidth = 2;
                  
                  if (dailyPercentages.length > 0) {
                        ctx.beginPath();
                        
                        // Create the line path
                        for (let i = 0; i < dailyPercentages.length; i++) {
                              const x = padding + (chartWidth * i / (dailyPercentages.length - 1));
                              const y = padding + chartHeight - (chartHeight * dailyPercentages[i] / maxValue);
                              
                              if (i === 0) {
                                    ctx.moveTo(x, y);
                              } else {
                                    ctx.lineTo(x, y);
                              }
                        }
                        
                        // Fill under the curve
                        ctx.lineTo(padding + chartWidth, padding + chartHeight);
                        ctx.lineTo(padding, padding + chartHeight);
                        ctx.closePath();
                        ctx.fill();
                        
                        // Draw the line
                        ctx.beginPath();
                        for (let i = 0; i < dailyPercentages.length; i++) {
                              const x = padding + (chartWidth * i / (dailyPercentages.length - 1));
                              const y = padding + chartHeight - (chartHeight * dailyPercentages[i] / maxValue);
                              
                              if (i === 0) {
                                    ctx.moveTo(x, y);
                              } else {
                                    ctx.lineTo(x, y);
                              }
                        }
                        ctx.stroke();
                  }
                  
                  // Draw labels
                  ctx.fillStyle = '#374151';
                  ctx.font = '12px Arial';
                  ctx.textAlign = 'center';
                  
                  // X-axis labels (every 5 days)
                  for (let day = 1; day <= daysInMonth; day += 5) {
                        const x = padding + (chartWidth * (day - 1) / (daysInMonth - 1));
                        ctx.fillText(day.toString(), x, padding + chartHeight + 20);
                  }
                  
                  // Y-axis labels
                  ctx.textAlign = 'right';
                  for (let i = 0; i <= 5; i++) {
                        const value = (maxValue * i / 5).toFixed(1);
                        const y = padding + chartHeight - (chartHeight * i / 5) + 4;
                        ctx.fillText(value + '%', padding - 10, y);
                  }
                  
                  // Chart titles
                  ctx.textAlign = 'center';
                  ctx.font = 'bold 14px Arial';
                  ctx.fillText('Daily Period Probability', rect.width / 2, 20);
                  
                  ctx.font = '12px Arial';
                  ctx.fillText('Day of Month', rect.width / 2, 200 - 5);
                  
                  // Y-axis title (rotated)
                  ctx.save();
                  ctx.translate(15, 100);
                  ctx.rotate(-Math.PI / 2);
                  ctx.fillText('Probability (%)', 0, 0);
                  ctx.restore();
            }

            // Clear chart when needed
            function clearChart() {
                  const canvas = document.getElementById('bellCurve');
                  const ctx = canvas.getContext('2d');
                  ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
      </script>
</script></body>
</html>